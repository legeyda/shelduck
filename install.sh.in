

# shelduck_src
# env: PREFIX?
#      DESTDIR
install_shelduck() {

	: "${DESTDIR:=}"

	if [ 0 = "$(id -u)" ]; then
		: "${PREFIX:=/opt}"
		: "${SYSCONFIGDIR:=/etc/opt}"
		: "${PROFILE_FILE:=$SYSCONFIGDIR/profile}"
		: "${CACHEDIR:=/var/opt/cache}"
	else
		: "${PREFIX:=$HOME/.local}"
		: "${SYSCONFIGDIR:=$HOME/.config}"
		: "${PROFILE_FILE:=$HOME/.profile}"
		: "${CACHEDIR:=$HOME/.cache}"
	fi
	: "${BINDIR:=$PREFIX/bin}"
	: "${DATAROOTDIR:=$PREFIX/share}"


	mkdir -p "$DESTDIR$BINDIR" "$DESTDIR$CACHEDIR/shelduck" "$DESTDIR$DATAROOTDIR/shelduck"

	# install
	mkdir -p "$DESTDIR$DATAROOTDIR/shelduck"
	: "${SHELDUCK_LIBRARY_URL:=https://raw.githubusercontent.com/legeyda/shelduck/refs/heads/main/shelduck.sh}"
	fetch_url "$SHELDUCK_LIBRARY_URL" > "$DESTDIR$DATAROOTDIR/shelduck/shelduck.sh"



	install_executable shelduck <<eof
#!/bin/sh
set -eux
if [ import = "\${1:-}" ]; then
	shift
	printf 'import subcommand not available when run from installed script %s\n' "\$0"
	printf "Instead source library:\n"
	printf '. "%s"\n' '$DESTDIR$DATAROOTDIR/shelduck/shelduck.sh'
	printf 'shelduck import'
	printf ' %s' "\$@"
	exit 1
fi
. '$DATAROOTDIR/shelduck/shelduck.sh'
shelduck "\$@"
eof

	install_executable shelduck_run <<eof
#!/bin/sh
set -eux
. '$DATAROOTDIR/shelduck/shelduck.sh'
shelduck_run "\$@"
eof



	# uninsatller
	mkdir -p "$DESTDIR$DATAROOTDIR/shelduck"
	cat > "$DESTDIR$DATAROOTDIR/shelduck/uninstall" << eof
#!/bin/sh
rm -f "$DATAROOTDIR/shelduck" "$BINDIR/shelduck" "$CACHEDIR/shelduck"
eof
	chmod +x "$DESTDIR$DATAROOTDIR/shelduck/uninstall"

	#
	if command_available shelduck; then
		log 'shelduck_resolve was successfully installed to %s, which seems to be already in the PATH' "$BINDIR"
		return
	fi

	log "adding $BINDIR to path"

	printf '\nPATH="%s:$PATH"' "$BINDIR" >> "$DESTDIR$PROFILE_FILE"

}

install_executable() {
	mkdir -p "$DESTDIR$BINDIR"
	cat > "$DESTDIR$BINDIR/$1"
	chmod +x "$DESTDIR$BINDIR/$1"
}



shelduck import -a die   -a command_available   -a log   \
	https://raw.githubusercontent.com/legeyda/bobshell/refs/heads/unstable/base.sh
shelduck import -a fetch_url   \
	https://raw.githubusercontent.com/legeyda/bobshell/refs/heads/unstable/url.sh

install_shelduck "$@"